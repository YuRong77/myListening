import{e as r,n as X,g as w,p as Y,f as Z,q as ee,c as u,m as ae,o as i,a as t,t as c,l as N,b as m,k as te,v as se,F as j,i as z,u as ne,w as le}from"./index-BU_Mq-Jv.js";import{u as oe}from"./tts-CzF03fPK.js";import{u as ue,w as ie}from"./playQueue-68t_IDgG.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const re={key:0,class:"wrap"},de={class:"head"},ve={class:"muted"},fe={key:0},pe={key:1},he={class:"controls"},_e=["disabled"],ke=["disabled"],be=["disabled"],me={class:"autoplay"},ye=["disabled"],ge={key:0,class:"loading"},we={key:1,class:"error"},Ce={key:2,class:"chat"},Se=["data-side","data-active","onClick"],Ae=["data-side"],xe={class:"bubble"},Ie={class:"en"},Ve={key:0,class:"zh"},Te={class:"meta"},Be={class:"tag"},De=["onClick"],Le={key:0,class:"vocab-wrap"},Pe={class:"vocab-list"},$e=["onClick","title"],Ee={class:"vtxt"},Fe={class:"word"},qe={key:0,class:"cn"},Me={class:"vocab-actions"},Ne=["disabled"],je=["disabled"],ze={key:1,class:"wrap"},Re={__name:"DialogueView",setup(Ue){const T=ue(),b=X(),R=ne(),o=oe(),C=r(b.params.category),S=r(b.params.dialogueId),A=r(!1),y=r(null),l=r(null),x=typeof window<"u"&&"speechSynthesis"in window,n=r(0),d=r(!1),v=r(!0),_=w(()=>l?.value?.turns||[]),g=w(()=>Array.isArray(l?.value?.vocab)?l.value.vocab:[]),B=w(()=>n.value>0),D=w(()=>n.value<_.value.length-1),f=r(!1),L=r(!1);function U(){const e={},a=l.value?.speakers||[];return a[0]&&(e[a[0].id||a[0].name||"A"]="A"),a[1]&&(e[a[1].id||a[1].name||"B"]="B"),e}const I=r({});function V(e){const a=e.speaker||"";return I.value[a]?I.value[a]:"A"}function W(e){return((l.value?.speakers||[]).find(h=>h.id===e.speaker||h.name===e.speaker)?.name||String(e.speaker||"")).slice(0,1).toUpperCase()||"S"}async function P(){A.value=!0,y.value=null,l.value=null,L.value=!1;try{const e=ie(`content/conversation/${C.value}/${S.value}.json`),a=await fetch(e,{headers:{"Cache-Control":"no-cache"}});if(!a.ok)throw new Error(`HTTP ${a.status}`);l.value=await a.json(),I.value=U(),n.value=0,x&&!o.ready&&await o.init(),T.speakTitleFirst&&l.value?.title?(L.value=!0,o.speak(String(l.value.title),"A",{onend:()=>{v.value&&p()},onerror:()=>{v.value&&p()}})):v.value&&p()}catch(e){y.value=e?.message||String(e)}finally{A.value=!1}}function p(){if(!x||!_.value.length)return;const e=_.value[n.value];if(!e||!e.en)return;const a=V(e);o.speak(e.en,a,{onend:()=>{if(v.value)if(n.value<_.value.length-1)n.value+=1,k(n.value),setTimeout(p,40);else{const s=T.next();s?R.push({name:"dialogue",params:{category:s.categoryId,dialogueId:s.dialogueId}}):d.value=!1}},onstart:()=>{d.value=!0},onerror:()=>{d.value=!1}})}function $(){d.value?(o.cancel(),d.value=!1):p()}function E(){D.value&&(o.cancel(),n.value+=1,k(n.value),(d.value||v.value)&&p())}function F(){B.value&&(o.cancel(),n.value-=1,k(n.value),(d.value||v.value)&&p())}function H(){o.cancel(),n.value=0,k(n.value),v.value&&p()}function K(e){o.cancel(),n.value=e,k(n.value),p()}function Q(e){n.value=e,k(n.value)}function k(){requestAnimationFrame(()=>{document.querySelector('[data-active="true"]')?.scrollIntoView({behavior:"smooth",block:"center"})})}function G(e){e&&(f.value=!0,o.speak(e,"A",{onend:()=>{f.value=!1},onerror:()=>{f.value=!1}}))}async function J(){if(g.value.length){f.value=!0;for(const e of g.value)await new Promise(a=>{o.speak(e.word,"A",{onend:a,onerror:a})});f.value=!1}}function O(){o.cancel(),f.value=!1}Y(()=>b.fullPath,()=>{C.value=b.params.category,S.value=b.params.dialogueId,o.cancel(),d.value=!1,f.value=!1,P()}),Z(()=>{P(),window.addEventListener("keydown",q)}),ee(()=>{o.cancel(),window.removeEventListener("keydown",q)});function q(e){e.code==="Space"?(e.preventDefault(),$()):e.key==="ArrowRight"?(e.preventDefault(),E()):e.key==="ArrowLeft"&&(e.preventDefault(),F())}return(e,a)=>ae(x)?(i(),u("section",re,[t("header",de,[t("div",null,[t("h1",null,c(l.value?.title||S.value),1),t("p",ve,[a[1]||(a[1]=N(" 分類：",-1)),t("code",null,c(C.value),1),l.value?.level?(i(),u("span",fe,"・Level "+c(l.value.level),1)):m("",!0),l.value?.speakers?.length?(i(),u("span",pe,"・"+c(l.value.speakers.length)+" speakers",1)):m("",!0)])]),t("div",he,[t("button",{class:"btn",onClick:F,disabled:!B.value},"⟵ 上一句",8,_e),t("button",{class:"btn primary",onClick:$,disabled:!l.value||_.value.length===0},c(d.value?"⏸ 暫停":"▶️ 播放"),9,ke),t("button",{class:"btn",onClick:E,disabled:!D.value},"下一句 ⟶",8,be),t("label",me,[te(t("input",{type:"checkbox","onUpdate:modelValue":a[0]||(a[0]=s=>v.value=s)},null,512),[[se,v.value]]),a[2]||(a[2]=N(" 連播 ",-1))]),t("button",{class:"btn ghost",onClick:H,disabled:!l.value},"↺ 重新開始",8,ye)])]),A.value?(i(),u("div",ge,"載入中…")):y.value?(i(),u("div",we,"讀取失敗："+c(y.value),1)):(i(),u("div",Ce,[(i(!0),u(j,null,z(_.value,(s,h)=>(i(),u("div",{key:h,class:"bubble-row","data-side":V(s)==="A"?"left":"right","data-active":h===n.value,onClick:M=>Q(h)},[t("div",{class:"avatar","data-side":V(s)==="A"?"left":"right"},c(W(s)),9,Ae),t("div",xe,[t("div",Ie,c(s.en),1),s.zh?(i(),u("div",Ve,c(s.zh),1)):m("",!0),t("div",Te,[t("span",Be,"Speaker "+c(s.speaker),1),t("button",{class:"mini",onClick:le(M=>K(h),["stop"])},"▶️ 單句",8,De)])])],8,Se))),128)),g.value.length?(i(),u("div",Le,[a[3]||(a[3]=t("h3",{class:"vocab-title"},"重點單字",-1)),t("ul",Pe,[(i(!0),u(j,null,z(g.value,(s,h)=>(i(),u("li",{key:h,class:"vocab-chip"},[t("button",{class:"vbtn",onClick:M=>G(s.word),title:"朗讀 "+s.word}," 🔊 ",8,$e),t("div",Ee,[t("span",Fe,c(s.word),1),s.cn?(i(),u("span",qe,"— "+c(s.cn),1)):m("",!0)])]))),128))]),t("div",Me,[t("button",{class:"btn small",onClick:J,disabled:f.value},"▶️ 全部朗讀",8,Ne),t("button",{class:"btn small ghost",onClick:O,disabled:!f.value},"⏹ 停止",8,je)])])):m("",!0)]))])):(i(),u("section",ze,[...a[4]||(a[4]=[t("div",{class:"error"}," 你的瀏覽器不支援 Web Speech Synthesis。請改用最新版 Chrome / Edge / Safari。 ",-1)])]))}},Ge=ce(Re,[["__scopeId","data-v-06d9ed61"]]);export{Ge as default};
