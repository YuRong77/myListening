import{e as d,l as z,g as x,m as U,f as R,n as W,c as i,k as H,o as u,a as t,t as c,p as $,b as A,q as K,v as G,F as J,i as O,w as Q}from"./index-CZ93thK6.js";import{u as X}from"./tts-Cxj0nIxU.js";import{w as Y}from"./base-url-y7lz57ex.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={key:0,class:"wrap"},ae={class:"head"},te={class:"muted"},se={key:0},ne={key:1},le={class:"controls"},oe=["disabled"],ie=["disabled"],ue=["disabled"],ce={class:"autoplay"},re=["disabled"],de={key:0,class:"loading"},ve={key:1,class:"error"},pe={key:2,class:"chat"},fe=["data-side","data-active","onClick"],he=["data-side"],_e={class:"bubble"},ke={class:"en"},me={key:0,class:"zh"},ye={class:"meta"},we={class:"tag"},ge=["onClick"],be={key:1,class:"wrap"},Ce={__name:"DialogueView",setup(Se){const k=z(),l=X(),y=d(k.params.category),w=d(k.params.dialogueId),g=d(!1),m=d(null),n=d(null),b=typeof window<"u"&&"speechSynthesis"in window,s=d(0),r=d(!1),p=d(!0),f=x(()=>n?.value?.turns||[]),I=x(()=>s.value>0),T=x(()=>s.value<f.value.length-1);function F(){const e={},a=n.value?.speakers||[];return a[0]&&(e[a[0].id||a[0].name||"A"]="A"),a[1]&&(e[a[1].id||a[1].name||"B"]="B"),e}const C=d({});function S(e){const a=e.speaker||"";return C.value[a]?C.value[a]:"A"}function M(e){return((n.value?.speakers||[]).find(v=>v.id===e.speaker||v.name===e.speaker)?.name||String(e.speaker||"")).slice(0,1).toUpperCase()||"S"}async function V(){g.value=!0,m.value=null,n.value=null;try{const e=Y(`content/conversation/${y.value}/${w.value}.json`),a=await fetch(e,{headers:{"Cache-Control":"no-cache"}});if(!a.ok)throw new Error(`HTTP ${a.status}`);n.value=await a.json(),C.value=F(),s.value=0,b&&!l.ready&&await l.init()}catch(e){m.value=e?.message||String(e)}finally{g.value=!1}}function h(){if(!b||!f.value.length)return;const e=f.value[s.value];if(!e||!e.en)return;const a=S(e);l.speak(e.en,a,{onend:()=>{p.value&&(s.value<f.value.length-1?(s.value+=1,_(s.value),setTimeout(h,40)):r.value=!1)},onstart:()=>{r.value=!0},onerror:()=>{r.value=!1}})}function B(){r.value?(l.cancel(),r.value=!1):h()}function D(){T.value&&(l.cancel(),s.value+=1,_(s.value),(r.value||p.value)&&h())}function E(){I.value&&(l.cancel(),s.value-=1,_(s.value),(r.value||p.value)&&h())}function N(){l.cancel(),s.value=0,_(s.value),p.value&&h()}function P(e){l.cancel(),s.value=e,_(s.value),h()}function j(e){s.value=e,_(s.value)}function _(e){requestAnimationFrame(()=>{document.querySelector('[data-active="true"]')?.scrollIntoView({behavior:"smooth",block:"center"})})}U(()=>k.fullPath,()=>{y.value=k.params.category,w.value=k.params.dialogueId,l.cancel(),r.value=!1,V()}),R(()=>{V(),window.addEventListener("keydown",L)}),W(()=>{l.cancel(),window.removeEventListener("keydown",L)});function L(e){e.code==="Space"?(e.preventDefault(),B()):e.key==="ArrowRight"?(e.preventDefault(),D()):e.key==="ArrowLeft"&&(e.preventDefault(),E())}return(e,a)=>H(b)?(u(),i("section",ee,[t("header",ae,[t("div",null,[t("h1",null,c(n.value?.title||w.value),1),t("p",te,[a[1]||(a[1]=$(" 分類：",-1)),t("code",null,c(y.value),1),n.value?.level?(u(),i("span",se,"・Level "+c(n.value.level),1)):A("",!0),n.value?.speakers?.length?(u(),i("span",ne,"・"+c(n.value.speakers.length)+" speakers",1)):A("",!0)])]),t("div",le,[t("button",{class:"btn",onClick:E,disabled:!I.value},"⟵ 上一句",8,oe),t("button",{class:"btn primary",onClick:B,disabled:!n.value||f.value.length===0},c(r.value?"⏸ 暫停":"▶️ 播放"),9,ie),t("button",{class:"btn",onClick:D,disabled:!T.value},"下一句 ⟶",8,ue),t("label",ce,[K(t("input",{type:"checkbox","onUpdate:modelValue":a[0]||(a[0]=o=>p.value=o)},null,512),[[G,p.value]]),a[2]||(a[2]=$(" 連播 ",-1))]),t("button",{class:"btn ghost",onClick:N,disabled:!n.value},"↺ 重新開始",8,re)])]),g.value?(u(),i("div",de,"載入中…")):m.value?(u(),i("div",ve,"讀取失敗："+c(m.value),1)):(u(),i("div",pe,[(u(!0),i(J,null,O(f.value,(o,v)=>(u(),i("div",{key:v,class:"bubble-row","data-side":S(o)==="A"?"left":"right","data-active":v===s.value,onClick:q=>j(v)},[t("div",{class:"avatar","data-side":S(o)==="A"?"left":"right"},c(M(o)),9,he),t("div",_e,[t("div",ke,c(o.en),1),o.zh?(u(),i("div",me,c(o.zh),1)):A("",!0),t("div",ye,[t("span",we,"Speaker "+c(o.speaker),1),t("button",{class:"mini",onClick:Q(q=>P(v),["stop"])},"▶️ 單句",8,ge)])])],8,fe))),128))]))])):(u(),i("section",be,[...a[3]||(a[3]=[t("div",{class:"error"}," 你的瀏覽器不支援 Web Speech Synthesis。請改用最新版 Chrome / Edge / Safari。 ",-1)])]))}},Ve=Z(Ce,[["__scopeId","data-v-966ed996"]]);export{Ve as default};
