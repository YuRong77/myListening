import{e as d,l as z,g as x,m as U,f as R,n as W,c as i,k as H,o as u,a as t,t as c,p as $,b as A,q as K,v as G,F as J,i as O,w as Q}from"./index-BRCfooDv.js";import{u as X}from"./tts-B5m--17Q.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Z={key:0,class:"wrap"},ee={class:"head"},ae={class:"muted"},te={key:0},se={key:1},ne={class:"controls"},le=["disabled"],oe=["disabled"],ie=["disabled"],ue={class:"autoplay"},ce=["disabled"],re={key:0,class:"loading"},de={key:1,class:"error"},ve={key:2,class:"chat"},pe=["data-side","data-active","onClick"],fe=["data-side"],he={class:"bubble"},_e={class:"en"},ke={key:0,class:"zh"},me={class:"meta"},ye={class:"tag"},be=["onClick"],ge={key:1,class:"wrap"},we={__name:"DialogueView",setup(Ce){const k=z(),l=X(),y=d(k.params.category),b=d(k.params.dialogueId),g=d(!1),m=d(null),n=d(null),w=typeof window<"u"&&"speechSynthesis"in window,s=d(0),r=d(!1),p=d(!0),f=x(()=>n?.value?.turns||[]),I=x(()=>s.value>0),T=x(()=>s.value<f.value.length-1);function F(){const e={},a=n.value?.speakers||[];return a[0]&&(e[a[0].id||a[0].name||"A"]="A"),a[1]&&(e[a[1].id||a[1].name||"B"]="B"),e}const C=d({});function S(e){const a=e.speaker||"";return C.value[a]?C.value[a]:"A"}function M(e){return((n.value?.speakers||[]).find(v=>v.id===e.speaker||v.name===e.speaker)?.name||String(e.speaker||"")).slice(0,1).toUpperCase()||"S"}async function V(){g.value=!0,m.value=null,n.value=null;try{const e=`/content/conversation/${y.value}/${b.value}.json`,a=await fetch(e,{headers:{"Cache-Control":"no-cache"}});if(!a.ok)throw new Error(`HTTP ${a.status}`);n.value=await a.json(),C.value=F(),s.value=0,w&&!l.ready&&await l.init()}catch(e){m.value=e?.message||String(e)}finally{g.value=!1}}function h(){if(!w||!f.value.length)return;const e=f.value[s.value];if(!e||!e.en)return;const a=S(e);l.speak(e.en,a,{onend:()=>{p.value&&(s.value<f.value.length-1?(s.value+=1,_(s.value),setTimeout(h,40)):r.value=!1)},onstart:()=>{r.value=!0},onerror:()=>{r.value=!1}})}function D(){r.value?(l.cancel(),r.value=!1):h()}function B(){T.value&&(l.cancel(),s.value+=1,_(s.value),(r.value||p.value)&&h())}function E(){I.value&&(l.cancel(),s.value-=1,_(s.value),(r.value||p.value)&&h())}function N(){l.cancel(),s.value=0,_(s.value),p.value&&h()}function P(e){l.cancel(),s.value=e,_(s.value),h()}function j(e){s.value=e,_(s.value)}function _(e){requestAnimationFrame(()=>{document.querySelector('[data-active="true"]')?.scrollIntoView({behavior:"smooth",block:"center"})})}U(()=>k.fullPath,()=>{y.value=k.params.category,b.value=k.params.dialogueId,l.cancel(),r.value=!1,V()}),R(()=>{V(),window.addEventListener("keydown",L)}),W(()=>{l.cancel(),window.removeEventListener("keydown",L)});function L(e){e.code==="Space"?(e.preventDefault(),D()):e.key==="ArrowRight"?(e.preventDefault(),B()):e.key==="ArrowLeft"&&(e.preventDefault(),E())}return(e,a)=>H(w)?(u(),i("section",Z,[t("header",ee,[t("div",null,[t("h1",null,c(n.value?.title||b.value),1),t("p",ae,[a[1]||(a[1]=$(" 分類：",-1)),t("code",null,c(y.value),1),n.value?.level?(u(),i("span",te,"・Level "+c(n.value.level),1)):A("",!0),n.value?.speakers?.length?(u(),i("span",se,"・"+c(n.value.speakers.length)+" speakers",1)):A("",!0)])]),t("div",ne,[t("button",{class:"btn",onClick:E,disabled:!I.value},"⟵ 上一句",8,le),t("button",{class:"btn primary",onClick:D,disabled:!n.value||f.value.length===0},c(r.value?"⏸ 暫停":"▶️ 播放"),9,oe),t("button",{class:"btn",onClick:B,disabled:!T.value},"下一句 ⟶",8,ie),t("label",ue,[K(t("input",{type:"checkbox","onUpdate:modelValue":a[0]||(a[0]=o=>p.value=o)},null,512),[[G,p.value]]),a[2]||(a[2]=$(" 連播 ",-1))]),t("button",{class:"btn ghost",onClick:N,disabled:!n.value},"↺ 重新開始",8,ce)])]),g.value?(u(),i("div",re,"載入中…")):m.value?(u(),i("div",de,"讀取失敗："+c(m.value),1)):(u(),i("div",ve,[(u(!0),i(J,null,O(f.value,(o,v)=>(u(),i("div",{key:v,class:"bubble-row","data-side":S(o)==="A"?"left":"right","data-active":v===s.value,onClick:q=>j(v)},[t("div",{class:"avatar","data-side":S(o)==="A"?"left":"right"},c(M(o)),9,fe),t("div",he,[t("div",_e,c(o.en),1),o.zh?(u(),i("div",ke,c(o.zh),1)):A("",!0),t("div",me,[t("span",ye,"Speaker "+c(o.speaker),1),t("button",{class:"mini",onClick:Q(q=>P(v),["stop"])},"▶️ 單句",8,be)])])],8,pe))),128))]))])):(u(),i("section",ge,[...a[3]||(a[3]=[t("div",{class:"error"}," 你的瀏覽器不支援 Web Speech Synthesis。請改用最新版 Chrome / Edge / Safari。 ",-1)])]))}},Ie=Y(we,[["__scopeId","data-v-889b8e9d"]]);export{Ie as default};
